@model List<AgroManagement.Models.AdminProductVM>

@{
    ViewData["Title"] = "Manage Products";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var categories = Model
        .Select(x => x.Category)
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .Distinct()
        .OrderBy(x => x)
        .ToList();
}

<div class="container mt-4">

    <!-- Page Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <h2 class="mb-0">Manage Products</h2>
            
        </div>

        <div class="d-flex flex-wrap gap-2">
            <div class="input-group" style="min-width:260px; max-width:360px;">
                <span class="input-group-text">🔎</span>
                <input id="searchBox" type="text" class="form-control" placeholder="Search by name or category..." />
            </div>

            <select id="categoryFilter" class="form-select" style="min-width:190px; max-width:240px;">
                <option value="">All Categories</option>
                @foreach (var c in categories)
                {
                    <option value="@c">@c</option>
                }
            </select>
        </div>
    </div>

    <!-- Table Card -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="productsTable">
                    <thead class="table-dark">
                        <tr>
                            <th style="width:160px;">Category</th>
                            <th>Name</th>
                            <th style="width:120px;">Unit</th>
                            <th style="width:120px;">Price</th>
                            <th style="width:120px;">Stock</th>
                            <th style="width:320px;">Update Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in Model.OrderBy(x => x.Category).ThenBy(x => x.Name))
                        {
                            var stock = p.Stock;

                            string badgeClass = "bg-success";
                            string badgeText = "In Stock";

                            if (stock <= 0)
                            {
                                badgeClass = "bg-danger";
                                badgeText = "Out";
                            }
                            else if (stock <= 3)
                            {
                                badgeClass = "bg-warning text-dark";
                                badgeText = "Low";
                            }

                            <tr class="product-row"
                                data-name="@p.Name"
                                data-category="@p.Category">
                                <td class="fw-semibold text-nowrap">@p.Category</td>
                                <td>
                                    <div class="fw-semibold">@p.Name</div>
                                    
                                </td>
                                <td class="text-nowrap">@p.UnitLabel</td>
                                <td class="text-nowrap">৳ @p.Price</td>
                                <td class="text-nowrap">
                                    <span class="badge @badgeClass">@badgeText</span>
                                    <span class="ms-2 fw-bold">@stock</span>
                                </td>
                                <td>
                                    <form method="post" action="/Admin/SetStock" class="d-flex gap-2 align-items-center">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="key" value="@p.Key" />

                                        <input type="number"
                                               class="form-control"
                                               name="stock"
                                               min="0"
                                               value="@p.Stock"
                                               style="max-width:120px;" />

                                        <button class="btn btn-success" type="submit">
                                            Save
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="p-4 text-center text-muted" style="display:none;">
                No products match your search/filter.
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const searchBox = document.getElementById("searchBox");
            const categoryFilter = document.getElementById("categoryFilter");
            const rows = Array.from(document.querySelectorAll(".product-row"));
            const emptyState = document.getElementById("emptyState");

            function normalize(s) { return (s || "").toLowerCase().trim(); }

            function applyFilters() {
                const q = normalize(searchBox.value);
                const cat = normalize(categoryFilter.value);

                let visibleCount = 0;

                rows.forEach(r => {
                    const name = normalize(r.getAttribute("data-name"));
                    const category = normalize(r.getAttribute("data-category"));

                    const matchSearch = !q || name.includes(q) || category.includes(q);
                    const matchCategory = !cat || category === cat;

                    const show = matchSearch && matchCategory;
                    r.style.display = show ? "" : "none";

                    if (show) visibleCount++;
                });

                emptyState.style.display = visibleCount === 0 ? "" : "none";
            }

            searchBox.addEventListener("input", applyFilters);
            categoryFilter.addEventListener("change", applyFilters);
        })();
    </script>
}
